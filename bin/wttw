#!/usr/bin/env bash
set -e
set -o pipefail

VERSION="0.0.1"
BRANCH=""
REMOTE_BRANCH=""
SESSION=$(tmux display-message -p "#S")
WORKTREE_PATH=""
PANES=6
LINK_NODE_MODULES=false

INTRO="
  wttw - create new git worktree in tmux window.

  Usage: wttw [options]
"
OPTIONS="
  Options:

    -b <GIT_REF> Set the branch name to create branch & worktree
    -r <GIT_REF> Set the remote branch ref to create branch
    -s <SESSION> Set the tmux session name to create window (Default: current tmux session name)
    -p <COUNT> Set the tmux pane count to split (Default: 6)
    -l Link node_modules directory (Default: false)
    -h Output usage information
    -v Output the version number
"

while getopts "b:s:r:p:lhv" option
do
  case $option in
    v)
      echo "$VERSION"
      exit;;
    h)
      echo "$INTRO $OPTIONS"
      exit;;
    b)
      BRANCH="$OPTARG"
      WORKTREE_PATH="../$BRANCH";;
    r)
      REMOTE_BRANCH="$OPTARG";;
    s)
      SESSION="$OPTARG";;
    p)
      PANES="$OPTARG";;
    l)
      LINK_NODE_MODULES=true;;
    \?)
      echo "$OPTIONS"
      exit 1;;
  esac
done

tmux_split_pane() {
  panes=$1
  case $panes in
    4)
      tmux splitw -v -p 50 -t 0 -c $PWD
      tmux splitw -h -p 50 -t 0 -c $PWD
      tmux splitw -h -p 50 -t 2 -c $PWD
      tmux selectp -t 0;;
    6)
      tmux splitw -v -p 50 -t 0 -c $PWD
      tmux splitw -h -p 33 -t 0 -c $PWD
      tmux splitw -h -p 50 -t 0 -c $PWD
      tmux splitw -h -p 33 -t 3 -c $PWD
      tmux splitw -h -p 50 -t 3 -c $PWD
      tmux selectp -t 0;;
    *)
      tmux splitw -v -p 50 -t 0 -c $PWD
      tmux splitw -h -p 33 -t 0 -c $PWD
      tmux splitw -h -p 50 -t 0 -c $PWD
      tmux splitw -h -p 33 -t 3 -c $PWD
      tmux splitw -h -p 50 -t 3 -c $PWD
      tmux selectp -t 0;;
  esac
}

tmux_create_window() {
  tmux new-window -t $2 -n $1 -c $3
  tmux select-window -t $1
}

workspace() {
  if [ ! -d "$WORKTREE_PATH" ]; then
    git worktree add $WORKTREE_PATH -b $BRANCH $REMOTE_BRANCH
  fi
  cd $WORKTREE_PATH
}

node_modules() {
  if $LINK_NODE_MODULES ; then
    ln -s $PWD/node_modules ../$BRANCH/node_modules
  fi
}

workspace
node_modules
tmux_create_window $BRANCH $SESSION $PWD
tmux_split_pane $PANES
